# SPDX-License-Identifier: GPL-2.0
#
# Copyright (C) 2026 Yuzhii0718
#
# All rights reserved.
#
# This file is part of the project bl-mt798x-dhcpd
# You may not use, copy, modify or distribute this file except in compliance with the license agreement.
#
name: FIP-FIT-2025 Build

on:
  workflow_dispatch:
    inputs:
      TARGET:
        description: 'Build target (format: soc,board). Default: all. e.g. mt7981,cmcc_a10'
        required: true
        default: 'all'
        type: string
      CUSTOM_IP:
        description: 'Custom default IP for DHCPD (e.g. 192.168.31.1)'
        required: false
        default: 'false'
        type: string
      pub_release:
        description: 'Publish to GitHub Release'
        required: false
        default: 'true'
        type: boolean

env:
  TZ: Asia/Shanghai

permissions:
  contents: write

jobs:
  generate_list:
    name: Generate build list
    runs-on: ubuntu-latest
    outputs:
      list: ${{ steps.list.outputs.list }}
      timestamp: ${{ steps.ts.outputs.timestamp }}

    steps:
      - name: Checkout source tree
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Generate timestamp
        id: ts
        run: |
          echo "timestamp=$(date -u +%Y%m%d%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Generate build list
        id: list
        run: |
          # Optional: build only one target when inputs.TARGET is provided as soc,board
          TARGET_RAW="${{ github.event.inputs.TARGET }}"
          TARGET_RAW="${TARGET_RAW:-all}"
          # Trim all whitespace so both "mt7981,cmcc_a10" and "mt7981, cmcc_a10" work.
          TARGET="$(echo "$TARGET_RAW" | tr -d '[:space:]')"

          ATF_DIR="atf-20250711/configs"
          UBOOT_DIR="uboot-mtk-20250711/configs-fit"

          # Build paired defconfig list: must exist in BOTH trees.
          CONFIG_LIST="$(
            if [ -d "$ATF_DIR" ] && [ -d "$UBOOT_DIR" ]; then
              # Find all *_defconfig in ATF, keep only those also present in U-Boot.
              find "$ATF_DIR" -maxdepth 1 -type f -name '*_defconfig' -printf '%f\n' 2>/dev/null \
                | while IFS= read -r def; do
                    [ -z "$def" ] && continue
                    [ -f "$UBOOT_DIR/$def" ] && echo "$def"
                  done \
                | sort -u
            fi
          )"

          if [ -n "$TARGET" ] && [ "$TARGET" != "all" ]; then
            if ! echo "$TARGET" | grep -Eq '^[A-Za-z0-9._-]+,[A-Za-z0-9._-]+$'; then
              echo "Illegal TARGET: '$TARGET_RAW' (expected: soc,board). e.g. mt7981,cmcc_a10" >&2
              exit 1
            fi

            SOC="${TARGET%%,*}"
            BOARD="${TARGET#*,}"
            DEFCONFIG="${SOC}_${BOARD}_defconfig"

            # Must exist as a valid pair
            if [ ! -f "$ATF_DIR/$DEFCONFIG" ] || [ ! -f "$UBOOT_DIR/$DEFCONFIG" ]; then
              echo "TARGET defconfig pair not found:" >&2
              echo "  missing: $ATF_DIR/$DEFCONFIG or $UBOOT_DIR/$DEFCONFIG" >&2
              echo "Available paired defconfigs:" >&2
              echo "$CONFIG_LIST" | sed 's/^/  - /' >&2
              exit 1
            fi

            JSON_LIST="{\"runner\": [\"ubuntu-latest\"],\"list\": [\"${DEFCONFIG}\"]}"
            echo "$JSON_LIST" | jq .
            echo "list=$JSON_LIST" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Default: build all paired defconfigs.
          CONFIGS="$(echo "$CONFIG_LIST" | awk '{printf "\"%s\",", $0}' | sed 's/,$//')"
          JSON_LIST="{\"runner\": [\"ubuntu-latest\"],\"list\": [$CONFIGS]}"
          echo "$JSON_LIST" | jq .
          echo "list=$JSON_LIST" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.list }}
    needs: generate_list
    runs-on: ${{ matrix.runner }}
    env:
      TIMESTAMP: ${{ needs.generate_list.outputs.timestamp }}
    strategy:
      matrix: ${{ fromJson(needs.generate_list.outputs.list) }}
      fail-fast: false
      max-parallel: 15

    steps:
      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get update
          sudo -E apt-get install gcc-aarch64-linux-gnu build-essential flex bison libssl-dev device-tree-compiler tar
          sudo timedatectl set-timezone "$TZ"

      - name: Checkout source tree
        uses: actions/checkout@v4

      - name: Apply a special network segment to U-Boot DHCPD
        if: github.event.inputs.CUSTOM_IP != 'false' && !cancelled()
        run: |
          set -euo pipefail

          CUSTOM_IP="${{ github.event.inputs.CUSTOM_IP }}"
          if [ "$CUSTOM_IP" = "false" ] || [ -z "$CUSTOM_IP" ]; then
            echo "Special network segment not enabled (CUSTOM_IP=false or not provided)"
            exit 0
          fi

          # Simple IPv4 validation (does not check the range of each segment)
          if ! echo "$CUSTOM_IP" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
            echo "Illegal CUSTOM_IP: $CUSTOM_IP"
            exit 1
          fi

          echo " Adjusting DHCPD configuration:"
          echo "  CONFIG_MTK_DHCPD_USE_CONFIG_IP default n"

          count=0
          for f in uboot-mtk-*/net/Kconfig; do
            if [ -f "$f" ]; then
              sed -i -E \
                -e '/^config[[:space:]]+MTK_DHCPD_USE_CONFIG_IP$/,/^config[[:space:]]+/ s/^\tdefault[[:space:]]+y$/\tdefault n/' \
                "$f"
              echo "Patched: $f"
            fi
          done

          # replace #define DHCPD_DEFAULT_IP_STR "xxx" with the custom IP, keeping the quotes
          for f in uboot-mtk-*/net/mtk_dhcpd.c; do
            if [ -f "$f" ]; then
              sed -i -E "s~(#define[[:space:]]+DHCPD_DEFAULT_IP_STR[[:space:]]+\")[0-9.]+(\")~\1${CUSTOM_IP}\2~" "$f"
              echo "Patched default IP in: $f"
              grep -E '#define[[:space:]]+DHCPD_DEFAULT_IP_STR' "$f"
              count=$((count+1))
            else
              echo "Warning: Can't find expected file for DHCPD IP patch: $f"
            fi
          done

          if [ "$count" -eq 0 ]; then
            echo "Warning: Did not find uboot-mtk-*/net/mtk_dhcpd.c files, skipping replacement"
          fi

          echo "CUSTOM_NET=1" >> $GITHUB_ENV
          echo "CUSTOM_NET_IP=${CUSTOM_IP}" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Build BL2 and FIP
        env:
          CONFIG: ${{ matrix.list }}
        run: |
          export SOC="${CONFIG%%_*}"
          BOARD="${CONFIG#*_}"
          export BOARD="${BOARD%_*}"
          mkdir -p "output"
          SOC="$SOC" BOARD="$BOARD" VERSION=2025 VARIANT=ubootmod ./build.sh 2>&1 | tee "output/build-${SOC}-${BOARD}-2025.log"
          echo "ARTIFACT_NAME=$SOC-$BOARD" >> "$GITHUB_ENV"

      - name: Organize and rename outputs
        run: |
          set -euo pipefail
          SUFFIX="-FIT-${TIMESTAMP}"

          export CONFIG="${{ matrix.list }}"
          export SOC="${CONFIG%%_*}"
          BOARD="${CONFIG#*_}"
          export BOARD="${BOARD%_*}"

          shopt -s nullglob
          for f in output/*; do
            [ -f "$f" ] || continue
            base="$(basename "$f")"
            if [[ "$base" == *.* ]]; then
              ext=".${base##*.}"
              name="${base%.*}"
              mv -f "$f" "output/${name}${SUFFIX}${ext}"
            else
              mv -f "$f" "output/${base}${SUFFIX}"
            fi
          done

          logs=(output/build-*.log output/*-build-*.log)
          if (( ${#logs[@]} )); then
            tar -czf "output/build-logs_${TIMESTAMP}.tar.gz" "${logs[@]}"
            rm -f "${logs[@]}"
          fi

          # Re-generate sha256sums AFTER renaming; exclude sha256sums itself.
          (
            cd output
            find . -maxdepth 1 -type f ! -name 'sha256sums*' -print0 \
              | sort -z \
              | xargs -0 sha256sum \
              > "sha256sums-${SOC}-${BOARD}${SUFFIX}.txt"
          )

      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            output/*
            !output/*bl2*

  release:
    name: Release firmware
    needs: [generate_list, build]
    runs-on: ubuntu-latest
    if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release tag
        run: |
          set -euo pipefail
          touch release.txt

          echo "- 提交来源: ${{ github.sha }}" >> release.txt
          echo "- 构建目标（TARGET）: ${{ github.event.inputs.TARGET }}" >> release.txt

          CUSTOM_IP="${{ github.event.inputs.CUSTOM_IP }}"
          if [ "$CUSTOM_IP" != "false" ] && [ -n "$CUSTOM_IP" ]; then
            if echo "$CUSTOM_IP"; then
              echo "- 已应用特殊网段: $CUSTOM_IP" >> release.txt
            else
              echo "- 特殊网段输入无效（CUSTOM_IP=$CUSTOM_IP），已保持默认网段192.168.1.1" >> release.txt
            fi
          else
            echo "- 保持默认网段192.168.1.1" >> release.txt
          fi

          echo "TIMESTAMP=${{ needs.generate_list.outputs.timestamp }}" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=FIT-dhcpd-${{ needs.generate_list.outputs.timestamp }}" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=FIT-dhcpd-${{ needs.generate_list.outputs.timestamp }}" >> "$GITHUB_ENV"

      - name: Publish firmware to Release
        if: github.event.inputs.pub_release == 'true' && !cancelled()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release.txt
          files: |
            dist/**